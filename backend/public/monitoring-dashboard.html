<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deals Checker - Professional Monitoring Dashboard</title>
    <title>System Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-[#0a0e27] to-[#1a1f3a] text-slate-100 p-6 min-h-screen font-sans">

    <div class="dashboard grid grid-cols-1 md:grid-cols-12 gap-6 max-w-[1800px] mx-auto">
        <header
            class="md:col-span-12 bg-gradient-to-br from-slate-800/80 to-slate-900/80 p-6 rounded-xl border border-slate-700 shadow-xl flex justify-between items-center relative overflow-hidden">
            <h1
                class="text-2xl font-extrabold bg-gradient-to-br from-indigo-400 to-cyan-400 bg-clip-text text-transparent flex items-center gap-3">
                System Monitor</h1>
            <div class="flex items-center gap-3">
                <div class="text-sm text-slate-300 bg-white/5 rounded-md px-3 py-1 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse inline-block"></span>
                    <span id="last-updated">Last updated: --</span>
                </div>
                <button
                    class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-4 py-2 font-semibold shadow-sm flex items-center gap-2"
                    id="refresh-btn">
                    <span>üîÑ</span>
                    <span>Refresh</span>
                </button>
                <button
                    class="bg-red-600 hover:bg-red-500 text-white rounded-lg px-4 py-2 font-semibold shadow-sm flex items-center gap-2"
                    id="cleanup-btn">
                    <span>üßπ</span>
                    <span>Cleanup</span>
                </button>
            </div>
        </header>

        <div
            class="card card-4 col-span-12 md:col-span-6 xl:col-span-4 bg-gradient-to-br from-slate-800/75 to-slate-900/75 p-6 rounded-xl border border-slate-700 shadow-md">
            <h2 class="text-lg font-bold mb-4 text-slate-100">üñ•Ô∏è System & CPU</h2>
            <div class="grid grid-cols-2 sm:grid-cols-2 gap-4">
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start w-full h-20">
                    <div class="text-xs text-slate-400 uppercase tracking-wide font-semibold">Hostname</div>
                    <div class="text-lg font-bold text-slate-100 mt-2" id="sys-hostname">--</div>
                </div>
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start w-full h-20">
                    <div class="text-xs text-slate-400 uppercase tracking-wide font-semibold">Platform</div>
                    <div class="text-lg font-bold text-slate-100 mt-2" id="sys-platform">--</div>
                </div>
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start w-full h-20">
                    <div class="text-xs text-slate-400 uppercase tracking-wide font-semibold">Uptime</div>
                    <div class="text-lg font-bold text-slate-100 mt-2" id="sys-uptime">--</div>
                </div>
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start w-full h-20">
                    <div class="text-xs text-slate-400 uppercase tracking-wide font-semibold">CPU</div>
                    <div class="relative w-full h-10 mt-2 bg-white/5 rounded overflow-hidden">
                        <div id="cpu-tile-fill"
                            class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-cyan-500 to-indigo-500 transition-[height]">
                        </div>
                        <div id="cpu-tile-label"
                            class="absolute inset-0 flex items-center justify-center text-sm font-semibold text-slate-100"
                            style="text-shadow:0 2px 6px rgba(0,0,0,0.9)">--%</div>
                    </div>
                </div>
            </div>
        </div>

        <div
            class="card card-4 col-span-12 md:col-span-6 xl:col-span-4 bg-gradient-to-br from-slate-800/75 to-slate-900/75 p-6 rounded-xl border border-slate-700 shadow-md">
            <h2 class="text-lg font-bold mb-4 text-slate-100">üíæ Memory</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start">
                    <div class="text-xs text-slate-400 mb-1 uppercase tracking-wide font-semibold">System Memory</div>
                    <div class="text-lg font-bold text-slate-100" id="mem-sys-used">--</div>
                </div>
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start">
                    <div class="text-xs text-slate-400 mb-1 uppercase tracking-wide font-semibold">Total App</div>
                    <div class="text-lg font-bold text-slate-100" id="mem-app-total">--</div>
                </div>
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start">
                    <div class="text-xs text-slate-400 mb-1 uppercase tracking-wide font-semibold">Node Process</div>
                    <div class="text-lg font-bold text-slate-100" id="mem-app-node">--</div>
                </div>
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start">
                    <div class="text-xs text-slate-400 mb-1 uppercase tracking-wide font-semibold">Browser Processes
                    </div>
                    <div class="text-lg font-bold text-slate-100" id="mem-app-browser">--</div>
                </div>
            </div>
        </div>

        <div
            class="card card-4 col-span-12 md:col-span-6 xl:col-span-4 bg-gradient-to-br from-slate-800/75 to-slate-900/75 p-6 rounded-xl border border-slate-700 shadow-md">
            <h2 class="text-lg font-bold mb-4 text-slate-100">üåê Browser Contexts</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start">
                    <div class="text-xs text-slate-400 mb-1 uppercase tracking-wide font-semibold">Status</div>
                    <div class="text-lg font-bold text-slate-100" id="ctx-status">--</div>
                </div>
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start">
                    <div class="text-xs text-slate-400 mb-1 uppercase tracking-wide font-semibold">Utilization</div>
                    <div class="text-lg font-bold text-slate-100" id="ctx-util">--</div>
                </div>
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start">
                    <div class="text-xs text-slate-400 mb-1 uppercase tracking-wide font-semibold">Active</div>
                    <div class="text-lg font-bold text-slate-100" id="ctx-active">--</div>
                </div>
                <div class="p-2 bg-white/5 rounded-md border border-white/5 flex flex-col items-start">
                    <div class="text-xs text-slate-400 mb-1 uppercase tracking-wide font-semibold">Total Pages</div>
                    <div class="text-lg font-bold text-slate-100" id="ctx-pages">--</div>
                </div>
            </div>
        </div>

        <div
            class="card card-full col-span-12 bg-gradient-to-br from-slate-800/75 to-slate-900/75 p-6 rounded-xl border border-slate-700 shadow-md">
            <h2 class="text-lg font-bold mb-4 text-slate-100">üìà Memory Usage Over Time</h2>
            <div class="relative h-[350px]">
                <canvas id="memoryChart"></canvas>
            </div>
        </div>

        <div
            class="card card-full col-span-12 bg-gradient-to-br from-slate-800/75 to-slate-900/75 p-6 rounded-xl border border-slate-700 shadow-md">
            <h2 class="text-lg font-bold mb-4 text-slate-100">üåê Browser Contexts Details</h2>
            <div class="max-h-[450px] overflow-y-auto rounded-md">
                <table id="contexts-table" class="min-w-full divide-y divide-slate-700">
                    <thead class="bg-white/3 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-xs text-slate-200 font-semibold text-left">Address</th>
                            <th class="px-4 py-3 text-xs text-slate-200 font-semibold text-left">Status</th>
                            <th class="px-4 py-3 text-xs text-slate-200 font-semibold text-left">Age</th>
                            <th class="px-4 py-3 text-xs text-slate-200 font-semibold text-left">Serviceability</th>
                            <th class="px-4 py-3 text-xs text-slate-200 font-semibold text-left">Pages</th>
                        </tr>
                    </thead>
                    <tbody class="bg-transparent">
                        <tr>
                            <td colspan="5" class="text-center py-6">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div
            class="card card-full col-span-12 bg-gradient-to-br from-slate-800/75 to-slate-900/75 p-6 rounded-xl border border-slate-700 shadow-md">
            <h2 class="text-lg font-bold mb-4 text-slate-100">‚öôÔ∏è Process Details</h2>
            <div class="max-h-[450px] overflow-y-auto rounded-md">
                <table id="procs-table" class="min-w-full divide-y divide-slate-700">
                    <thead class="bg-white/3 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-xs text-slate-200 font-semibold text-left">Type</th>
                            <th class="px-4 py-3 text-xs text-slate-200 font-semibold text-left">PID/Count</th>
                            <th class="px-4 py-3 text-xs text-slate-200 font-semibold text-left">Memory (MB)</th>
                            <th class="px-4 py-3 text-xs text-slate-200 font-semibold text-left">Details</th>
                        </tr>
                    </thead>
                    <tbody class="bg-transparent">
                        <tr>
                            <td colspan="4" class="text-center py-6">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast"></div>
    <div id="alert-container"></div>

    <script>
        const API_ENDPOINT = '/api/monitoring/system';
        const CLEANUP_ENDPOINT = '/api/monitoring/contexts/cleanup';
        const REFRESH_INTERVAL = 5000; // 5 seconds
        const MAX_DATA_POINTS = 60; // Last 5 minutes

        const refreshBtn = document.getElementById('refresh-btn');
        const cleanupBtn = document.getElementById('cleanup-btn');

        let memoryChart;
        const memoryHistory = {
            labels: [],
            total: [],
            node: [],
            browser: []
        };

        function formatUptime(seconds) {
            const d = Math.floor(seconds / (3600 * 24));
            const h = Math.floor(seconds % (3600 * 24) / 3600);
            const m = Math.floor(seconds % 3600 / 60);
            return `${d}d ${h}h ${m}m`;
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const base = 'fixed bottom-8 left-1/2 transform -translate-x-1/2 rounded-lg font-semibold transition-opacity z-50 px-6 py-3 opacity-0 pointer-events-none';
            const colorClass = isError ? 'bg-red-600 text-white' : 'bg-emerald-500 text-white';
            toast.className = `${base} ${colorClass}`;
            toast.textContent = message;
            // show
            setTimeout(() => {
                toast.classList.remove('opacity-0');
                toast.classList.add('opacity-100', 'pointer-events-auto');
            }, 50);
            // hide after 3s
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'pointer-events-auto');
                toast.classList.add('opacity-0');
            }, 3000);
        }

        function showAlert(title, message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            const alertDiv = document.createElement('div');
            alertDiv.id = alertId;
            // choose colors
            let bg = '#6366f1';
            if (type === 'warning') bg = '#f59e0b';
            if (type === 'error') bg = '#ef4444';
            alertDiv.style.background = bg;
            alertDiv.style.color = '#fff';
            alertDiv.style.borderRadius = '8px';
            alertDiv.style.padding = '12px 16px';
            alertDiv.style.boxShadow = '0 10px 20px rgba(0,0,0,0.3)';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.maxWidth = '420px';
            alertDiv.style.transform = 'translateX(500px)';
            alertDiv.style.transition = 'transform 0.25s ease';
            alertDiv.innerHTML = `
                <div style="font-size:1.25rem; margin-right:8px">${type === 'warning' ? '‚ö†Ô∏è' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</div>
                <div style="flex:1">
                    <div style="font-weight:700">${title}</div>
                    <div style="opacity:0.95; margin-top:4px; font-size:0.95rem">${message}</div>
                </div>
                <button style="background:transparent;border:none;color:#fff;font-size:1rem;cursor:pointer;margin-left:8px" onclick="document.getElementById('${alertId}').remove()">‚úï</button>
            `;
            alertDiv.style.display = 'flex';
            alertDiv.style.alignItems = 'flex-start';
            alertDiv.style.gap = '10px';

            container.appendChild(alertDiv);
            // slide in
            setTimeout(() => { alertDiv.style.transform = 'translateX(0)'; }, 100);
            // Auto-remove after 8 seconds
            setTimeout(() => {
                alertDiv.style.transform = 'translateX(500px)';
                setTimeout(() => alertDiv.remove(), 300);
            }, 8000);
        }

        function checkForAlerts(data) {
            // Alerts for memory usage removed as per user request
            // Visual indicators in the UI (badges, colors) still provide feedback
        }

        function renderSystemInfo(data) {
            document.getElementById('sys-hostname').textContent = data.system.hostname;
            document.getElementById('sys-platform').textContent = `${data.system.platform} (${data.system.architecture})`;
            document.getElementById('sys-uptime').textContent = formatUptime(data.system.uptimeSeconds);

            const currentLoad = data.cpu.loadAveragePercent['1min'];

            // Update CPU usage bar
            updateCpuUsage(currentLoad);
        }

        function updateCpuUsage(value) {
            const fill = document.getElementById('cpu-tile-fill');
            const label = document.getElementById('cpu-tile-label');
            const pct = Math.min(value, 100);
            fill.style.height = `${pct}%`;
            label.textContent = `${value}%`;
            const base = 'absolute bottom-0 left-0 w-full transition-[height] rounded-b-lg';
            if (value >= 90) {
                fill.className = base + ' bg-gradient-to-t from-red-500 to-rose-600';
            } else if (value >= 70) {
                fill.className = base + ' bg-gradient-to-t from-yellow-400 to-orange-500';
            } else {
                fill.className = base + ' bg-gradient-to-t from-cyan-500 to-indigo-500';
            }
        }

        function renderMemoryInfo(data) {
            // System memory with badge
            const sysUsagePercent = data.system.usagePercent;
            let sysBadgeClass = 'bg-emerald-100 text-emerald-600';
            let sysLabel = 'Good';
            if (sysUsagePercent >= 90) { sysBadgeClass = 'bg-red-100 text-red-600'; sysLabel = 'Critical'; }
            else if (sysUsagePercent >= 75) { sysBadgeClass = 'bg-amber-100 text-amber-600'; sysLabel = 'High'; }
            else if (sysUsagePercent >= 50) { sysBadgeClass = 'bg-indigo-100 text-indigo-600'; sysLabel = 'Normal'; }
            const sysBadge = `<span class="inline-block text-xs font-semibold px-2 py-0.5 rounded ${sysBadgeClass}">${sysLabel}</span>`;
            document.getElementById('mem-sys-used').innerHTML = `${data.system.usedMB} / ${data.system.totalMB} MB ${sysBadge}`;

            // Application memory
            document.getElementById('mem-app-total').innerHTML = `${data.application.totalMB} MB`;

            // Node memory with percentage badge
            const nodeBadge = `<span class="inline-block text-xs font-semibold px-2 py-0.5 rounded bg-indigo-100 text-indigo-600">${data.application.breakdownPercent.node}%</span>`;
            document.getElementById('mem-app-node').innerHTML = `${data.application.nodeMB} MB ${nodeBadge}`;

            // Browser memory with percentage badge and alert
            let browserBadgeClass = 'bg-indigo-100 text-indigo-600';
            if (data.application.browserMB > 1500) browserBadgeClass = 'bg-red-100 text-red-600';
            else if (data.application.browserMB > 1000) browserBadgeClass = 'bg-amber-100 text-amber-600';
            const browserBadge = `<span class="inline-block text-xs font-semibold px-2 py-0.5 rounded ${browserBadgeClass}">${data.application.breakdownPercent.browser}%</span>`;
            document.getElementById('mem-app-browser').innerHTML = `${data.application.browserMB} MB ${browserBadge}`;
        }

        function renderContextsSummary(data) {
            // Status with badge
            let statusBadge = '';
            if (data.status === 'running') {
                statusBadge = `<span class="inline-block text-xs font-semibold px-2 py-0.5 rounded bg-emerald-100 text-emerald-600">‚úì</span>`;
            } else {
                statusBadge = `<span class="inline-block text-xs font-semibold px-2 py-0.5 rounded bg-red-100 text-red-600">‚úó</span>`;
            }
            document.getElementById('ctx-status').innerHTML = `${data.status} ${statusBadge}`;

            // Utilization with color coding
            let utilBadge = '';
            if (data.utilizationPercent >= 90) {
                utilBadge = `<span class="inline-block text-xs font-semibold px-2 py-0.5 rounded bg-red-100 text-red-600">Full</span>`;
            } else if (data.utilizationPercent >= 70) {
                utilBadge = `<span class="inline-block text-xs font-semibold px-2 py-0.5 rounded bg-amber-100 text-amber-600">High</span>`;
            } else {
                utilBadge = `<span class="inline-block text-xs font-semibold px-2 py-0.5 rounded bg-emerald-100 text-emerald-600">OK</span>`;
            }
            document.getElementById('ctx-util').innerHTML = `${data.total} / ${data.max} ${utilBadge}`;

            document.getElementById('ctx-active').textContent = data.active;
            document.getElementById('ctx-pages').textContent = data.totalPages;
        }

        function renderContextsTable(contexts) {
            const tbody = document.querySelector('#contexts-table tbody');
            if (!contexts || !Array.isArray(contexts.list) || contexts.list.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <div class="empty-state-icon">üåê</div>
                                <div class="empty-state-text">No browser contexts found</div>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            // Helper to derive serviceable and unserviceable websites for a context
            function extractSites(ctx) {
                // Check if serviceability object is available
                if (ctx.serviceability && typeof ctx.serviceability === 'object') {
                    const serviceable = [];
                    const unserviceable = [];
                    
                    for (const [website, isServiceable] of Object.entries(ctx.serviceability)) {
                        if (isServiceable === true) {
                            serviceable.push(website);
                        } else if (isServiceable === false) {
                            unserviceable.push(website);
                        }
                    }
                    
                    return { serviceable, unserviceable };
                }
                
                // Prefer explicit fields if provided by backend
                if (Array.isArray(ctx.serviceableWebsites) && ctx.serviceableWebsites.length) {
                    return { serviceable: ctx.serviceableWebsites, unserviceable: [] };
                }
                if (Array.isArray(ctx.serviceable) && ctx.serviceable.length) {
                    return { serviceable: ctx.serviceable, unserviceable: [] };
                }
                if (Array.isArray(ctx.sites) && ctx.sites.length) {
                    return { serviceable: ctx.sites, unserviceable: [] };
                }

                // Fallback: derive hostnames from pages array
                if (Array.isArray(ctx.pages) && ctx.pages.length) {
                    const hosts = ctx.pages.map(p => {
                        try {
                            const u = p.url || p.originalUrl || p.address || '';
                            if (!u) return (p.title || '').slice(0, 40);
                            const parsed = new URL(u);
                            return parsed.hostname.replace(/^www\./i, '');
                        } catch (e) {
                            return (p.title || '').slice(0, 40);
                        }
                    }).filter(Boolean);
                    return { serviceable: Array.from(new Set(hosts)), unserviceable: [] };
                }

                return { serviceable: [], unserviceable: [] };
            }

            tbody.innerHTML = contexts.list.map(ctx => {
                const isOld = ctx.ageMinutes > 30;
                const ageClass = isOld ? 'text-amber-400' : 'text-slate-200';
                let dotColor = 'bg-emerald-500';
                if (ctx.status && ctx.status !== 'running') dotColor = 'bg-rose-500';

                // Pages HTML (existing) ‚Äî render inside a fixed-height, scrollable container to avoid huge rows
                const pagesHtml = (Array.isArray(ctx.pages) && ctx.pages.length > 0) ? `
                    <div class="max-h-40 overflow-y-auto mt-2 pr-1">
                        <ul class="space-y-1">
                            ${ctx.pages.map(p => `<li class="text-sm text-slate-400 bg-white/3 rounded px-2 py-1">üìÑ ${p.title || 'Untitled'}</li>`).join('')}
                        </ul>
                    </div>` : '';

                // Sites / serviceability column - show both serviceable and unserviceable websites
                const sitesData = extractSites(ctx);
                let sitesHtml = '‚Äî';
                
                if (sitesData.serviceable.length > 0 || sitesData.unserviceable.length > 0) {
                    let serviceableHtml = '';
                    let unserviceableHtml = '';
                    
                    // Serviceable websites (green badges)
                    if (sitesData.serviceable.length > 0) {
                        serviceableHtml = sitesData.serviceable.map(s =>
                            `<span class="inline-block text-xs bg-emerald-500/20 text-emerald-300 px-2 py-0.5 rounded mr-1 mb-1">‚úì ${s}</span>`
                        ).join('');
                    }
                    
                    // Unserviceable websites (red badges)
                    if (sitesData.unserviceable.length > 0) {
                        unserviceableHtml = sitesData.unserviceable.map(s =>
                            `<span class="inline-block text-xs bg-red-500/20 text-red-300 px-2 py-0.5 rounded mr-1 mb-1">‚úó ${s}</span>`
                        ).join('');
                    }
                    
                    sitesHtml = `<div class="flex flex-wrap items-center -mr-1">${serviceableHtml}${unserviceableHtml}</div>`;
                }

                return `
                    <tr class="odd:bg-transparent even:bg-white/2">
                        <td class="px-4 py-3 font-semibold">${ctx.originalAddress}</td>
                        <td class="px-4 py-3"><span class="inline-block w-2 h-2 rounded-full mr-3 ${dotColor}"></span>${ctx.status}</td>
                        <td class="px-4 py-3 ${ageClass}">${ctx.ageMinutes} min</td>
                        <td class="px-4 py-3">${sitesHtml}</td>
                        <td class="px-4 py-3">
                            <strong>${(Array.isArray(ctx.pages) ? ctx.pages.length : 0)} page${(Array.isArray(ctx.pages) && ctx.pages.length) !== 1 ? 's' : ''}</strong>
                            ${pagesHtml}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderProcessesTable(data) {
            const tbody = document.querySelector('#procs-table tbody');
            const node = data.node;
            const browser = data.browser;
            let rows = '';
            rows += `
                <tr class="bg-white/3 border-l-2 border-indigo-500/30">
                    <td class="px-4 py-3 font-semibold">üü£ Node.js</td>
                    <td class="px-4 py-3">PID ${node.pid}</td>
                    <td class="px-4 py-3 font-bold">${node.memoryMB.rss}</td>
                    <td class="px-4 py-3">Heap: ${node.memoryMB.heapUsed} / ${node.memoryMB.heapTotal} MB <span class="text-slate-400 ml-4">External: ${node.memoryMB.external} MB</span></td>
                </tr>
                <tr class="bg-white/3 border-l-2 border-sky-500/30">
                    <td class="px-4 py-3 font-semibold">üîµ Browser</td>
                    <td class="px-4 py-3">${browser.processCount} process${browser.processCount !== 1 ? 'es' : ''}</td>
                    <td class="px-4 py-3 font-bold">${browser.totalMemoryMB}</td>
                    <td class="px-4 py-3">Avg: ${browser.averageMemoryMB} MB / process</td>
                </tr>
            `;

            if (browser.list.length > 0) {
                rows += browser.list.map((p, idx) => `
                    <tr class="bg-sky-900/5 border-l-4 border-sky-500/20">
                        <td class="px-4 py-3 text-slate-400">‚îî‚îÄ Process ${idx + 1}</td>
                        <td class="px-4 py-3 text-slate-400">PID ${p.pid}</td>
                        <td class="px-4 py-3">${p.memoryMB}</td>
                        <td class="px-4 py-3 text-slate-400 font-mono text-sm truncate max-w-[500px]">${p.command}</td>
                    </tr>
                `).join('');
            } else if (browser.processCount === 0) {
                rows += `
                    <tr>
                        <td colspan="4">
                            <div class="p-6 text-center text-slate-400">
                                <div class="text-2xl mb-2">üîç</div>
                                <div class="font-semibold">No browser processes detected</div>
                            </div>
                        </td>
                    </tr>
                `;
            }

            tbody.innerHTML = rows;
        }

        function initMemoryChart() {
            const ctx = document.getElementById('memoryChart').getContext('2d');
            memoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: memoryHistory.labels,
                    datasets: [
                        {
                            label: 'Total App Memory',
                            data: memoryHistory.total,
                            borderColor: 'rgba(129, 140, 248, 1)',
                            backgroundColor: 'rgba(129, 140, 248, 0.15)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            pointBackgroundColor: 'rgba(129, 140, 248, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Browser Memory',
                            data: memoryHistory.browser,
                            borderColor: 'rgba(6, 182, 212, 1)',
                            backgroundColor: 'rgba(6, 182, 212, 0.15)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            pointBackgroundColor: 'rgba(6, 182, 212, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Node Memory',
                            data: memoryHistory.node,
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.15)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#f3f4f6',
                                font: {
                                    size: 13,
                                    weight: '600'
                                },
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 31, 58, 0.95)',
                            titleColor: '#f3f4f6',
                            bodyColor: '#d1d5db',
                            borderColor: '#2d3748',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' MB';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#9ca3af',
                                font: { size: 11 }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            }
                        },
                        y: {
                            ticks: {
                                color: '#9ca3af',
                                font: { size: 11 },
                                callback: function (value) {
                                    return value + ' MB';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Memory (MB)',
                                color: '#d1d5db',
                                font: {
                                    size: 13,
                                    weight: '600'
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateMemoryChart(timestamp, memoryData) {
            memoryHistory.labels.push(timestamp);
            memoryHistory.total.push(memoryData.application.totalMB);
            memoryHistory.node.push(memoryData.application.nodeMB);
            memoryHistory.browser.push(memoryData.application.browserMB);

            if (memoryHistory.labels.length > MAX_DATA_POINTS) {
                memoryHistory.labels.shift();
                memoryHistory.total.shift();
                memoryHistory.node.shift();
                memoryHistory.browser.shift();
            }

            memoryChart.update('none');
        }

        let isFirstLoad = true;
        // prevent overlapping requests ‚Äî if a fetch is in-flight, skip starting another
        let isFetching = false;

        async function fetchData() {
            // skip if a previous fetch is still pending
            if (isFetching) {
                // silently skip; optional: console.debug or lightweight toast
                console.debug('fetchData: previous request still pending ‚Äî skipping');
                return;
            }

            isFetching = true;
            refreshBtn.disabled = true;
            const refreshText = refreshBtn.querySelector('span:last-child');
            refreshText.textContent = 'Refreshing...';

            try {
                const res = await fetch(API_ENDPOINT);
                if (!res.ok) {
                    throw new Error(`Server responded with status ${res.status}`);
                }
                const data = await res.json();
                const timestamp = new Date(data.timestamp).toLocaleTimeString();

                document.getElementById('last-updated').textContent = `Last updated: ${timestamp}`;
                renderSystemInfo(data);
                renderMemoryInfo(data.memory);
                renderContextsSummary(data.browserContexts);
                renderContextsTable(data.browserContexts);
                renderProcessesTable(data.processes);
                updateMemoryChart(timestamp, data.memory);

                // Check for alerts (only after first load to avoid initial spam)
                if (!isFirstLoad) {
                    checkForAlerts(data);
                }
                isFirstLoad = false;

            } catch (error) {
                showToast('Failed to fetch data: ' + error.message, true);
                console.error('Fetch error:', error);
            } finally {
                isFetching = false;
                refreshBtn.disabled = false;
                refreshText.textContent = 'Refresh';
            }
        }

        async function cleanupContexts() {
            if (!confirm('Are you sure you want to clean up idle browser contexts?')) {
                return;
            }
            cleanupBtn.disabled = true;
            const cleanupText = cleanupBtn.querySelector('span:last-child');
            cleanupText.textContent = 'Cleaning...';

            try {
                const res = await fetch(CLEANUP_ENDPOINT, { method: 'POST' });
                const result = await res.json();
                if (!res.ok) {
                    throw new Error(result.message || 'Cleanup failed');
                }

                const message = result.cleanedContexts > 0
                    ? `‚úì Cleaned up ${result.cleanedContexts} context${result.cleanedContexts !== 1 ? 's' : ''}`
                    : '‚úì No contexts needed cleanup';
                showToast(message);

                // Show memory delta if available
                if (result.memoryDelta) {
                    const delta = result.memoryDelta.rss;
                    if (delta < 0) {
                        showAlert('Memory Freed', `Freed ${Math.abs(delta)} MB of memory`, 'info');
                    }
                }

                setTimeout(fetchData, 1000); // Refresh data after cleanup
            } catch (error) {
                showToast('Cleanup failed: ' + error.message, true);
                console.error('Cleanup error:', error);
            } finally {
                cleanupBtn.disabled = false;
                cleanupText.textContent = 'Cleanup';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMemoryChart();
            fetchData(); // Initial fetch
            setInterval(fetchData, REFRESH_INTERVAL);

            refreshBtn.addEventListener('click', fetchData);
            cleanupBtn.addEventListener('click', cleanupContexts);
        });
    </script>
</body>

</html>